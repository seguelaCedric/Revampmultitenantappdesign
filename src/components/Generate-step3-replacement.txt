        {/* Step 3: Choose Blueprint */}
        {currentStep === 3 && selectedPipelineType && (
          <div className="space-y-6">
            {!selectedBlueprint ? (
              <>
                <div>
                  <h2 className="text-slate-900 mb-2">Choose Blueprint</h2>
                  <p className="text-slate-600">Select a blueprint for your {selectedPipelineType ? pipelineTypes[selectedPipelineType as keyof typeof pipelineTypes].name : 'content'}</p>
                </div>

                {/* Search & Filters */}
                <div className="flex gap-4">
                  <div className="flex-1 relative">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                    <Input
                      placeholder="Search blueprints..."
                      value={blueprintSearch}
                      onChange={(e) => setBlueprintSearch(e.target.value)}
                      className="pl-12 h-12 bg-white border-slate-200 rounded-xl shadow-sm"
                    />
                  </div>
                </div>

                {/* Blueprints Grid */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {filteredBlueprints.map((blueprint) => {
                    const pipelineType = pipelineTypes[blueprint.pipelineType as keyof typeof pipelineTypes];
                    return (
                      <Card
                        key={blueprint.id}
                        className="group border-slate-200/60 hover:border-slate-300 shadow-lg hover:shadow-xl transition-all cursor-pointer"
                        onClick={() => {
                          setSelectedBlueprint(blueprint);
                          // Pre-fill variables from selected ideas if available
                          if (selectedIdeas.length > 0) {
                            const firstIdea = selectedIdeas[0];
                            setVariables(firstIdea.variables);
                          }
                        }}
                      >
                        <CardContent className="p-6">
                          <div className="flex gap-4">
                            {/* Icon */}
                            <div className={`w-16 h-16 rounded-xl bg-gradient-to-br ${pipelineType.gradient} flex items-center justify-center text-2xl flex-shrink-0 shadow-lg`}>
                              {pipelineType.icon}
                            </div>

                            {/* Content */}
                            <div className="flex-1 min-w-0">
                              <div className="flex items-start justify-between mb-2">
                                <h3 className="text-slate-900 mb-1">{blueprint.name}</h3>
                                <Badge className={`${pipelineType.bg} ${pipelineType.text} ${pipelineType.border} ml-2 whitespace-nowrap`}>
                                  {pipelineType.name}
                                </Badge>
                              </div>
                              <p className="text-sm text-slate-600 mb-3">{blueprint.description}</p>

                              <div className="space-y-2">
                                <div className="flex items-center gap-2 text-xs text-slate-500">
                                  <Settings className="w-3 h-3" />
                                  <span>Variables: {blueprint.variables.map(v => `{{${v}}}`).join(', ')}</span>
                                </div>
                                <div className="flex items-center gap-2 text-xs text-slate-500">
                                  <Sparkles className="w-3 h-3" />
                                  <span>AI: {blueprint.llmModel} + {blueprint.mediaModel}</span>
                                </div>
                                <div className="flex items-center gap-2 text-xs text-slate-500">
                                  <TrendingUp className="w-3 h-3" />
                                  <span>Used {blueprint.usageCount} times • Last: {blueprint.lastUsed}</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    );
                  })}
                </div>

                {filteredBlueprints.length === 0 && (
                  <Card className="border-slate-200/60 shadow-sm">
                    <CardContent className="flex flex-col items-center justify-center py-12">
                      <div className="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mb-4">
                        <Search className="w-8 h-8 text-slate-400" />
                      </div>
                      <h3 className="text-lg text-slate-900 mb-2">No blueprints found</h3>
                      <p className="text-sm text-slate-500 text-center max-w-md">
                        Try adjusting your search or filter criteria
                      </p>
                    </CardContent>
                  </Card>
                )}

                <div className="flex justify-between pt-6">
                  <Button variant="outline" onClick={() => setCurrentStep(2)} className="rounded-xl">
                    <ArrowLeft className="w-4 h-4 mr-2" />
                    Back
                  </Button>
                </div>
              </>
            ) : (
              <>
                {/* Blueprint Selected - Show Variable Configuration */}
                <div>
                  <h2 className="text-slate-900 mb-2">Configure Variables</h2>
                  <p className="text-slate-600">Review and fill in all required variables for your blueprint</p>
                </div>

                {/* Selected Blueprint Info */}
                <Card className="border-slate-200/60 shadow-lg">
                  <CardHeader>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${pipelineTypes[selectedBlueprint.pipelineType as keyof typeof pipelineTypes].gradient} flex items-center justify-center text-2xl shadow-lg`}>
                          {pipelineTypes[selectedBlueprint.pipelineType as keyof typeof pipelineTypes].icon}
                        </div>
                        <div>
                          <CardTitle>{selectedBlueprint.name}</CardTitle>
                          <CardDescription>{selectedBlueprint.description}</CardDescription>
                        </div>
                      </div>
                      <Button variant="outline" size="sm" onClick={() => setSelectedBlueprint(null)}>
                        Change Blueprint
                      </Button>
                    </div>
                  </CardHeader>
                </Card>

                {/* Variables from Ideas */}
                {selectedIdeas.length > 0 && (
                  <Card className="border-green-200 bg-green-50 shadow-lg">
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2 text-green-900">
                        <Check className="w-5 h-5" />
                        Variables from Selected Ideas
                      </CardTitle>
                      <CardDescription className="text-green-700">
                        These variables will be used from your {selectedIdeas.length} selected {selectedIdeas.length === 1 ? 'idea' : 'ideas'}
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <div className="space-y-3">
                        {selectedIdeas.map((idea) => (
                          <div key={idea.id} className="p-3 bg-white rounded-lg border border-green-200">
                            <div className="text-sm text-slate-900 mb-2">{idea.name}</div>
                            <div className="flex flex-wrap gap-2">
                              {Object.entries(idea.variables).map(([key, value]) => (
                                <div key={key} className="text-xs">
                                  <code className="bg-green-100 px-2 py-0.5 rounded text-green-700">{`{{${key}}}`}</code>
                                  <span className="text-slate-600 ml-1">= {value}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Fill Missing Variables */}
                {selectedBlueprint && (() => {
                  // Check which variables are missing across all selected ideas
                  const allIdeaVariables = selectedIdeas.flatMap(idea => Object.keys(idea.variables));
                  const missingVariables = selectedBlueprint.variables.filter(v => !allIdeaVariables.includes(v));
                  
                  if (missingVariables.length > 0) {
                    return (
                      <Card className="border-amber-200 bg-amber-50 shadow-lg">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 text-amber-900">
                            <Info className="w-5 h-5" />
                            Fill Missing Variables
                          </CardTitle>
                          <CardDescription className="text-amber-700">
                            These variables are required by the blueprint but not provided by your ideas
                          </CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          {missingVariables.map((variable) => (
                            <div key={variable}>
                              <Label htmlFor={variable} className="flex items-center gap-2 mb-2">
                                <code className="bg-white px-2 py-0.5 rounded text-amber-600">{`{{${variable}}}`}</code>
                                <span className="text-slate-700 capitalize">{variable}</span>
                                <span className="text-red-500">*</span>
                              </Label>
                              
                              {variable === 'product' && (
                                <Select value={variables[variable] || ''} onValueChange={(v) => setVariables({...variables, [variable]: v})}>
                                  <SelectTrigger className="h-11 bg-white">
                                    <SelectValue placeholder="Select product..." />
                                  </SelectTrigger>
                                  <SelectContent>
                                    {mockAssets.products.map(item => (
                                      <SelectItem key={item.id} value={item.name}>{item.name}</SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              )}
                              
                              {variable === 'angle' && (
                                <Select value={variables[variable] || ''} onValueChange={(v) => setVariables({...variables, [variable]: v})}>
                                  <SelectTrigger className="h-11 bg-white">
                                    <SelectValue placeholder="Select angle..." />
                                  </SelectTrigger>
                                  <SelectContent>
                                    {mockAssets.angles.map(item => (
                                      <SelectItem key={item.id} value={item.name}>{item.name}</SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              )}
                              
                              {variable === 'voice' && (
                                <Select value={variables[variable] || ''} onValueChange={(v) => setVariables({...variables, [variable]: v})}>
                                  <SelectTrigger className="h-11 bg-white">
                                    <SelectValue placeholder="Select voice..." />
                                  </SelectTrigger>
                                  <SelectContent>
                                    {mockAssets.voices.map(item => (
                                      <SelectItem key={item.id} value={item.name}>{item.name}</SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              )}

                              {variable === 'character' && (
                                <Select value={variables[variable] || ''} onValueChange={(v) => setVariables({...variables, [variable]: v})}>
                                  <SelectTrigger className="h-11 bg-white">
                                    <SelectValue placeholder="Select character..." />
                                  </SelectTrigger>
                                  <SelectContent>
                                    {mockAssets.characters.map(item => (
                                      <SelectItem key={item.id} value={item.name}>{item.name}</SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              )}

                              {variable === 'story' && (
                                <Select value={variables[variable] || ''} onValueChange={(v) => setVariables({...variables, [variable]: v})}>
                                  <SelectTrigger className="h-11 bg-white">
                                    <SelectValue placeholder="Select story element..." />
                                  </SelectTrigger>
                                  <SelectContent>
                                    {mockAssets.stories.map(item => (
                                      <SelectItem key={item.id} value={item.name}>{item.name}</SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              )}

                              {!['product', 'angle', 'voice', 'character', 'story'].includes(variable) && (
                                <Input
                                  id={variable}
                                  value={variables[variable] || ''}
                                  onChange={(e) => setVariables({...variables, [variable]: e.target.value})}
                                  placeholder={`Enter ${variable}...`}
                                  className="h-11 bg-white"
                                />
                              )}
                            </div>
                          ))}
                        </CardContent>
                      </Card>
                    );
                  }
                  
                  return null;
                })()}

                {/* All Variables Ready */}
                {selectedBlueprint && (() => {
                  const allIdeaVariables = selectedIdeas.flatMap(idea => Object.keys(idea.variables));
                  const missingVariables = selectedBlueprint.variables.filter(v => !allIdeaVariables.includes(v));
                  const allVariablesFilled = missingVariables.every(v => variables[v]);
                  
                  if (allVariablesFilled || missingVariables.length === 0) {
                    return (
                      <Card className="border-green-200 bg-green-50 shadow-lg">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2 text-green-900">
                            <Check className="w-5 h-5" />
                            All Variables Ready
                          </CardTitle>
                          <CardDescription className="text-green-700">
                            Everything is configured. Ready to generate!
                          </CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="text-sm text-green-800">
                            ✨ {selectedIdeas.length} {selectedIdeas.length === 1 ? 'piece' : 'pieces'} of content will be generated using {selectedBlueprint.name}
                          </div>
                        </CardContent>
                      </Card>
                    );
                  }
                  
                  return null;
                })()}

                <div className="flex justify-between pt-6">
                  <Button variant="outline" onClick={() => setSelectedBlueprint(null)} className="rounded-xl">
                    <ArrowLeft className="w-4 h-4 mr-2" />
                    Change Blueprint
                  </Button>
                  <Button
                    onClick={handleGenerate}
                    disabled={selectedBlueprint && (() => {
                      const allIdeaVariables = selectedIdeas.flatMap(idea => Object.keys(idea.variables));
                      const missingVariables = selectedBlueprint.variables.filter(v => !allIdeaVariables.includes(v));
                      return !missingVariables.every(v => variables[v]);
                    })()}
                    className={`bg-gradient-to-r ${selectedPipelineType ? pipelineTypes[selectedPipelineType as keyof typeof pipelineTypes].gradient : 'from-slate-600 to-slate-500'} text-white rounded-xl shadow-lg px-8`}
                  >
                    <Zap className="w-4 h-4 mr-2" />
                    Generate {selectedIdeas.length} {selectedIdeas.length === 1 ? 'Piece' : 'Pieces'}
                  </Button>
                </div>
              </>
            )}
          </div>
        )}
